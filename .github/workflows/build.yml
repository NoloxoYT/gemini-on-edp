name: Build and Release Chrome Extension

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install CRX packager
        run: npm install -g crx

      - name: Recreate PEM file from secret
        run: echo ${{ secrets.EXTENSION_PEM_BASE64 }} | base64 --decode > extension.pem

      - name: Auto-bump version in manifest.json
        id: bump_version
        run: |
          node -e "
          const fs = require('fs');
          const manifest = JSON.parse(fs.readFileSync('manifest.json'));
          const parts = manifest.version.split('.');
          parts[2] = (parseInt(parts[2]) + 1).toString();
          manifest.version = parts.join('.');
          fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
          console.log('::set-output name=version::' + manifest.version);
          "

      - name: Zip Extension
        run: mkdir -p dist && zip -r dist/mon_extension.zip * -x "*.github/*" "*.pem"

      - name: Build CRX
        run: crx pack ./ -o dist/mon_extension.crx -p extension.pem

      - name: Create GitHub Release
        id: gh_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump_version.outputs.version }}
          name: Chrome Extension v${{ steps.bump_version.outputs.version }}
          body: "Release automatique via CI"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZIP
        uses: softprops/action-gh-release@v1
        with:
          files: dist/mon_extension.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload CRX
        uses: softprops/action-gh-release@v1
        with:
          files: dist/mon_extension.crx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
