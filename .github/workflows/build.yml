name: Build and Release Chrome Extension

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install CRX packager
        run: npm install -g crx

      - name: Recreate PEM file from secret
        run: echo "${{ secrets.EXTENSION_PEM_BASE64 }}" | base64 --decode > extension.pem

      - name: Auto-bump version in manifest.json
        id: bump_version
        run: |
          node <<'EOF'
          const fs = require('fs');
          const manifestPath = 'manifest.json';
          const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
          const parts = manifest.version.split('.');
          while (parts.length < 3) parts.push('0'); // always MAJOR.MINOR.PATCH
          parts[2] = (Number(parts[2]) + 1).toString();
          manifest.version = parts.join('.');
          fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
          console.log(`version=${manifest.version}`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${manifest.version}\n`);
          EOF

      - name: Zip Extension
        run: |
          mkdir -p dist
          zip -r dist/Gemini_on_EDP.zip . -x ".github/*" "*.pem" "dist/*" "node_modules/*"

      - name: Build CRX
        run: crx pack ./ -o dist/Gemini_onEDP.crx -p extension.pem

      - name: Create GitHub Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump_version.outputs.version }}
          name: Chrome Extension v${{ steps.bump_version.outputs.version }}
          body: "Release automatique via CI"
          files: |
            dist/mon_extension.zip
            dist/mon_extension.crx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
